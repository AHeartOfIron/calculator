<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EORE Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body>
    <div class="top-controls">
        <a href="index.html" class="control-btn" title="–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é">
            <i class="fas fa-home"></i>
        </a>
        <button class="control-btn" onclick="toggleLanguage()" title="–ó–º—ñ–Ω–∏—Ç–∏ –º–æ–≤—É" id="langBtn">üá∫üá¶</button>
    </div>
    
    <div class="calculator-container">
        <div class="calc-header">
            <h1><i class="fas fa-exclamation-triangle"></i> <span id="title">EORE Calculator</span></h1>
            <p id="subtitle">Explosive Ordnance Risk Education - –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤–∞—Ä—Ç–æ—Å—Ç—ñ –Ω–∞–≤—á–∞–Ω–Ω—è –∑ –±–µ–∑–ø–µ–∫–∏</p>
        </div>

        <div class="tab-content">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label" id="distance-label">–í—ñ–¥—Å—Ç–∞–Ω—å –¥–æ –æ–±'—î–∫—Ç–∞ (–∫–º)</label>
                    <input type="number" class="form-control" id="eore-distance" step="0.1" placeholder="0.0">
                </div>
                <div class="form-group">
                    <label class="form-label" id="fuel-price-label">–í–∞—Ä—Ç—ñ—Å—Ç—å –ø–∞–ª–∏–≤–∞ (–≥—Ä–Ω/–ª)</label>
                    <input type="number" class="form-control" id="fuel-price" value="65" step="0.1">
                </div>
                <div class="form-group">
                    <label class="form-label" id="fuel-consumption-label">–†–æ–∑—Ö—ñ–¥ –ø–∞–ª–∏–≤–∞ (–ª/100–∫–º)</label>
                    <input type="number" class="form-control" id="fuel-consumption" value="17" step="0.1">
                </div>

                <div class="form-group">
                    <label class="form-label" id="trips-label">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤–∏—ó–∑–¥—ñ–≤</label>
                    <input type="number" class="form-control" id="trips-count" value="1" min="1">
                    <small style="color: var(--text-secondary); margin-top: 5px; display: block;" id="trips-note">1 –≤–∏—ó–∑–¥ = —Ç—É–¥–∏ —Ç–∞ –Ω–∞–∑–∞–¥ (–ø–æ–¥–≤—ñ–π–Ω–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å)</small>
                </div>

                <div class="form-group">
                    <label class="form-label" id="urgency-label-top">–¢–µ—Ä–º—ñ–Ω–æ–≤—ñ—Å—Ç—å</label>
                    <div class="form-control" style="display: flex; align-items: center;">
                        <input type="checkbox" id="eore-urgent" style="width: 20px; height: 20px; margin: 0 10px 0 0;">
                        <label for="eore-urgent" id="urgency-label" style="color: var(--text-primary); cursor: pointer; margin: 0;">–¢–µ—Ä–º—ñ–Ω–æ–≤—ñ—Å—Ç—å</label>
                    </div>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="calculateEORE()">
                    <i class="fas fa-calculator"></i> <span id="calc-btn">–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏</span>
                </button>
                <button class="btn btn-secondary" onclick="showCoefficients()">
                    <i class="fas fa-cog"></i> <span id="coeff-btn">–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏</span>
                </button>
                <button class="btn btn-secondary" onclick="openRouteCalculator('eore-distance')">
                    <i class="fas fa-route"></i> <span id="route-btn">–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –º–∞—Ä—à—Ä—É—Ç—É</span>
                </button>
                <button class="btn btn-secondary" onclick="exportPDF()" id="exportBtn" style="display: none;">
                    <i class="fas fa-file-pdf"></i> <span id="export-btn">–ï–∫—Å–ø–æ—Ä—Ç PDF</span>
                </button>
            </div>
            
            <div id="eore-result" style="display: none;"></div>
        </div>

        <!-- Coefficients Modal -->
        <div class="modal fade" id="coefficientsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border);">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modal-title"><i class="fas fa-cog"></i> –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç—ñ–≤ EORE</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" id="label-base">–ë–∞–∑–æ–≤–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å (–≥—Ä–Ω)</label>
                                <input type="number" class="form-control" id="coeff-base" value="5000">
                            </div>
                            <div class="form-group">
                                <label class="form-label" id="label-urgent">–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç —Ç–µ—Ä–º—ñ–Ω–æ–≤–æ—Å—Ç—ñ (%)</label>
                                <input type="number" class="form-control" id="coeff-urgent" value="20">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btn-cancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        <button type="button" class="btn btn-primary" onclick="saveCoefficients()" id="btn-save">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Route component will be loaded here -->
        <div id="routeComponent"></div>
        
        <style>
        .top-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .control-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #ff0040;
            background: #000;
            color: #ff0040;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            font-family: 'Times New Roman', serif;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(255, 0, 64, 0.2);
        }
        
        .control-btn:hover {
            background: #ff0040;
            color: #000;
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(255, 0, 64, 0.4);
        }
        </style>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Load route component -->
    <script>
        function openRouteCalculator(distanceFieldId) {
            window.targetDistanceField = distanceFieldId;
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;';
            
            const lang = localStorage.getItem('language') || 'uk';
            const closeTexts = { uk: '–ó–∞–∫—Ä–∏—Ç–∏', en: 'Close', fr: 'Fermer' };
            
            modal.innerHTML = `
                <div style="background: var(--bg-primary); border: 1px solid var(--border); border-radius: 15px; width: 95%; height: 90%; position: relative;">
                    <div style="position: absolute; top: 10px; right: 15px; z-index: 2001;">
                        <button onclick="closeRouteModal()" style="background: var(--primary); color: #000; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-times"></i> ${closeTexts[lang]}
                        </button>
                    </div>
                    <iframe src="route_calculator_mini.html" style="width: 100%; height: 100%; border: none; border-radius: 15px;" onload="this.contentWindow.postMessage({type: 'setLanguage', language: localStorage.getItem('language') || 'uk'}, '*')"></iframe>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentRouteModal = modal;
        }
        
        function closeRouteModal() {
            if (window.currentRouteModal) {
                window.currentRouteModal.remove();
                window.currentRouteModal = null;
            }
        }
        
        // Listen for route distance from calculator
        window.addEventListener('message', function(event) {
            if (event.data.type === 'routeDistance') {
                if (window.targetDistanceField) {
                    document.getElementById(window.targetDistanceField).value = event.data.distance;
                    window.targetDistanceField = null;
                } else {
                    document.getElementById('eore-distance').value = event.data.distance;
                }
                closeRouteModal();
            }
        });
    </script>

    <script>
        let lastCalculation = null;
        
        function showCoefficients() {
            const coefficients = getCoefficients();
            const lang = localStorage.getItem('language') || 'uk';
            
            // Update modal text
            const modalTexts = {
                uk: {
                    title: '–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç—ñ–≤ EORE',
                    base: '–ë–∞–∑–æ–≤–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å (–≥—Ä–Ω)',
                    urgent: '–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç —Ç–µ—Ä–º—ñ–Ω–æ–≤–æ—Å—Ç—ñ (%)',
                    cancel: '–°–∫–∞—Å—É–≤–∞—Ç–∏',
                    save: '–ó–±–µ—Ä–µ–≥—Ç–∏'
                },
                en: {
                    title: 'EORE Coefficients Settings',
                    base: 'Base cost (UAH)',
                    urgent: 'Urgency coefficient (%)',
                    cancel: 'Cancel',
                    save: 'Save'
                },
                fr: {
                    title: 'Param√®tres des coefficients EORE',
                    base: 'Co√ªt de base (UAH)',
                    urgent: 'Coefficient d\'urgence (%)',
                    cancel: 'Annuler',
                    save: 'Sauvegarder'
                }
            };
            
            const t = modalTexts[lang];
            document.getElementById('modal-title').innerHTML = `<i class="fas fa-cog"></i> ${t.title}`;
            document.getElementById('label-base').textContent = t.base;
            document.getElementById('label-urgent').textContent = t.urgent;
            document.getElementById('btn-cancel').textContent = t.cancel;
            document.getElementById('btn-save').textContent = t.save;
            
            document.getElementById('coeff-base').value = coefficients.base;
            document.getElementById('coeff-urgent').value = coefficients.urgent;
            
            new bootstrap.Modal(document.getElementById('coefficientsModal')).show();
        }
        
        function getCoefficients() {
            const defaults = {
                base: 5000,
                urgent: 20
            };
            
            const saved = localStorage.getItem('eoreCoefficients');
            return saved ? JSON.parse(saved) : defaults;
        }

        function saveCoefficients() {
            const coefficients = {
                base: parseFloat(document.getElementById('coeff-base').value),
                urgent: parseFloat(document.getElementById('coeff-urgent').value)
            };
            
            localStorage.setItem('eoreCoefficients', JSON.stringify(coefficients));
            bootstrap.Modal.getInstance(document.getElementById('coefficientsModal')).hide();
            alert('–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
        }
        
        function calculateEORE() {
            const distance = parseFloat(document.getElementById('eore-distance').value) || 0;
            const fuelPrice = parseFloat(document.getElementById('fuel-price').value) || 65;
            const fuelConsumption = parseFloat(document.getElementById('fuel-consumption').value) || 17;
            const tripsCount = parseInt(document.getElementById('trips-count').value) || 1;
            const urgent = document.getElementById('eore-urgent').checked;
            const coeffs = getCoefficients();
            
            // EORE: –ë–∞–∑–æ–≤–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å + –¥–æ—Ä–æ–≥–∞ + —Ç–µ—Ä–º—ñ–Ω–æ–≤—ñ—Å—Ç—å
            const baseCost = coeffs.base;
            const roadCost = distance * (fuelConsumption / 100) * fuelPrice * 2 * tripsCount;
            
            let subtotal = baseCost + roadCost;
            const urgentCost = urgent ? subtotal * (coeffs.urgent / 100) : 0;
            const totalCost = subtotal + urgentCost;
            
            lastCalculation = {
                type: 'EORE',
                distance, fuelPrice, fuelConsumption, tripsCount, urgent,
                baseCost, roadCost, urgentCost, totalCost,
                timestamp: new Date().toLocaleString(),
                formula: `–§–æ—Ä–º—É–ª–∞: ${coeffs.base} –≥—Ä–Ω + –ø–∞–ª–∏–≤–æ(${distance} –∫–º √ó ${fuelConsumption}/100 √ó ${fuelPrice} –≥—Ä–Ω/–ª √ó 2 √ó ${tripsCount} –≤–∏—ó–∑–¥—ñ–≤ = ${roadCost.toFixed(2)} –≥—Ä–Ω)${urgent ? ` + ${coeffs.urgent}% —Ç–µ—Ä–º—ñ–Ω–æ–≤—ñ—Å—Ç—å` : ''} = ${totalCost.toFixed(2)} –≥—Ä–Ω`
            };
            
            document.getElementById('eore-result').innerHTML = `
                <div class="result-card">
                    <div class="result-title">–í–∞—Ä—Ç—ñ—Å—Ç—å EORE: ${totalCost.toFixed(2)} –≥—Ä–Ω</div>
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin: 15px 0; font-family: monospace; font-size: 0.9rem;">
                        <strong>üìä –§–æ—Ä–º—É–ª–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É:</strong><br>
                        ${lastCalculation.formula}
                    </div>
                    <div class="result-details">
                        <div class="detail-item">
                            <strong>EORE –Ω–∞–≤—á–∞–Ω–Ω—è (—Ñ—ñ–Ω–∞–ª—å–Ω–æ)</strong><br>
                            ${(baseCost + urgentCost).toFixed(2)} –≥—Ä–Ω
                        </div>
                        <div class="detail-item">
                            <strong>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç (—Ñ—ñ–Ω–∞–ª—å–Ω–æ)</strong><br>
                            ${roadCost.toFixed(2)} –≥—Ä–Ω
                        </div>
                        <div class="detail-item">
                            <strong>–¢–µ—Ä–º—ñ–Ω–æ–≤—ñ—Å—Ç—å</strong><br>
                            ${urgentCost.toFixed(2)} –≥—Ä–Ω
                        </div>

                        <div class="detail-item">
                            <strong>–ü–∞—Ä–∞–º–µ—Ç—Ä–∏</strong><br>
                            ${distance} –∫–º, ${tripsCount} –≤–∏—ó–∑–¥—ñ–≤<br>
                            ${fuelConsumption}–ª/100–∫–º, ${fuelPrice}–≥—Ä–Ω/–ª
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('eore-result').style.display = 'block';
            document.getElementById('exportBtn').style.display = 'inline-flex';
            
            saveToHistory('EORE', lastCalculation);
        }

        function exportPDF() {
            if (!lastCalculation) {
                const lang = localStorage.getItem('language') || 'uk';
                const alertTexts = {
                    uk: '–°–ø–æ—á–∞—Ç–∫—É –≤–∏–∫–æ–Ω–∞–π—Ç–µ —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫',
                    en: 'Please perform calculation first',
                    fr: 'Veuillez d\'abord effectuer le calcul'
                };
                alert(alertTexts[lang] || alertTexts.en);
                return;
            }
            
            const lang = localStorage.getItem('language') || 'uk';
            const promptTexts = {
                uk: '–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó:',
                en: 'Enter organization name:',
                fr: 'Entrez le nom de l\'organisation:'
            };
            
            const orgName = prompt(promptTexts[lang] || promptTexts.en, 'EORE Training Services');
            if (!orgName) return;
            
            const managerName = prompt('Enter manager name:', 'John Smith');
            if (!managerName) return;
            
            const managerPosition = prompt('Enter position:', 'Director');
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // –ü—Ä–æ—Å—Ç–∏–π PDF
            
            // –§–æ–Ω —Ç–∞ —Ä–∞–º–∫–∞
            doc.setFillColor(240, 240, 240);
            doc.rect(0, 0, 210, 297, 'F');
            doc.setDrawColor(200, 0, 0);
            doc.setLineWidth(2);
            doc.rect(10, 10, 190, 277);
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            doc.setFillColor(200, 0, 0);
            doc.rect(15, 15, 180, 25, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            const pdfTexts = {
                uk: {
                    title: 'COMMERCIAL PROPOSAL',
                    date: 'Date:',
                    proposal: 'Proposal No:',
                    params: 'PROJECT PARAMETERS:',
                    distance: 'Distance to object:',
                    trips: 'Number of trips:',
                    urgency: 'Urgency:',
                    fuel: 'Fuel:',
                    yes: 'Yes',
                    no: 'No',
                    cost: 'COST CALCULATION:',
                    service: 'Service Description',
                    price: 'Cost (UAH)',
                    training: 'EORE safety training',
                    transport: 'Logistics and transport',
                    total: 'TOTAL COST:',
                    valid: 'This proposal is valid for 30 days',
                    manager: 'Project Manager:',
                    signature: 'Signature:',
                    currency: 'UAH'
                },
                en: {
                    title: 'COMMERCIAL PROPOSAL',
                    date: 'Date:',
                    proposal: 'Proposal No:',
                    params: 'PROJECT PARAMETERS:',
                    distance: 'Distance to object:',
                    trips: 'Number of trips:',
                    urgency: 'Urgency:',
                    fuel: 'Fuel:',
                    yes: 'Yes',
                    no: 'No',
                    cost: 'COST CALCULATION:',
                    service: 'Service Description',
                    price: 'Cost (UAH)',
                    training: 'EORE safety training',
                    transport: 'Logistics and transport',
                    total: 'TOTAL COST:',
                    valid: 'This proposal is valid for 30 days',
                    manager: 'Project Manager:',
                    signature: 'Signature:',
                    currency: 'UAH'
                },
                fr: {
                    title: 'PROPOSITION COMMERCIALE',
                    date: 'Date:',
                    proposal: 'Proposition No:',
                    params: 'PARAM√àTRES DU PROJET:',
                    distance: 'Distance √† l\'objet:',
                    trips: 'Nombre de voyages:',
                    urgency: 'Urgence:',
                    fuel: 'Carburant:',
                    yes: 'Oui',
                    no: 'Non',
                    cost: 'CALCUL DU CO√õT:',
                    service: 'Description du service',
                    price: 'Co√ªt (UAH)',
                    training: 'Formation √† la s√©curit√© EORE',
                    transport: 'Logistique et transport',
                    total: 'CO√õT TOTAL:',
                    valid: 'Cette proposition est valide pendant 30 jours',
                    manager: 'Chef de projet:',
                    signature: 'Signature:',
                    currency: 'UAH'
                }
            };
            
            const t = pdfTexts[lang];
            
            doc.text(t.title, 105, 30, { align: 'center' });
            doc.setFontSize(14);
            doc.text(orgName, 105, 35, { align: 'center' });
            
            // –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(t.date + ' ' + lastCalculation.timestamp, 20, 55);
            doc.text(t.proposal + ' EORE-' + Date.now().toString().slice(-6), 120, 55);
            
            // –ü–∞—Ä–∞–º–µ—Ç—Ä–∏
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(t.params, 20, 75);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            let y = 85;
            doc.text(`${t.distance} ${lastCalculation.distance} km`, 25, y);
            y += 8;
            doc.text(`${t.trips} ${lastCalculation.tripsCount}`, 25, y);
            y += 8;
            doc.text(`${t.urgency} ${lastCalculation.urgent ? t.yes : t.no}`, 25, y);
            y += 8;
            doc.text(`${t.fuel} ${lastCalculation.fuelPrice} ${t.currency}/l, ${lastCalculation.fuelConsumption} l/100km`, 25, y);
            
            // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫
            y += 20;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text(t.cost, 20, y);
            
            y += 10;
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.5);
            
            // –¢–∞–±–ª–∏—Ü—è
            doc.setFillColor(230, 230, 230);
            doc.rect(20, y, 120, 8, 'FD');
            doc.rect(140, y, 50, 8, 'FD');
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text(t.service, 25, y + 5);
            doc.text(t.price, 145, y + 5);
            
            y += 8;
            doc.setFont('helvetica', 'normal');
            const rows = [];
            if (lastCalculation.baseCost > 0) {
                rows.push([t.training, lastCalculation.baseCost.toFixed(2)]);
            }
            if (lastCalculation.roadCost > 0) {
                rows.push([t.transport, lastCalculation.roadCost.toFixed(2)]);
            }
            if (lastCalculation.urgentCost > 0) {
                rows.push(['Urgency surcharge', lastCalculation.urgentCost.toFixed(2)]);
            }
            
            rows.forEach(row => {
                doc.rect(20, y, 120, 8, 'D');
                doc.rect(140, y, 50, 8, 'D');
                doc.text(row[0], 25, y + 5);
                doc.text(row[1], 165, y + 5, { align: 'right' });
                y += 8;
            });
            
            // –ü—ñ–¥—Å—É–º–æ–∫
            doc.setFillColor(200, 0, 0);
            doc.rect(20, y, 170, 10, 'FD');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text(t.total, 25, y + 7);
            doc.text(lastCalculation.totalCost.toFixed(2) + ' ' + t.currency, 165, y + 7, { align: 'right' });
            
            // –ü—ñ–¥–ø–∏—Å
            y += 30;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(t.valid, 20, y);
            y += 20;
            doc.text(`${managerPosition} ${orgName}: ${managerName}`, 20, y);
            doc.text(t.signature + ' ________________', 120, y);
            
            doc.save(`EORE_Proposal_${new Date().toISOString().split('T')[0]}.pdf`);
        }
        
        function saveToHistory(type, data) {
            const history = JSON.parse(localStorage.getItem('calculatorHistory') || '[]');
            history.unshift(data);
            
            if (history.length > 100) history.splice(100);
            localStorage.setItem('calculatorHistory', JSON.stringify(history));
        }
        
        let routeData = { routes: [], selectedRoute: null, targetInput: null };
        let routeMap = null;
        let pointMarkers = { A: null, B: null };
        let currentPointMode = null;
        
        function showRouteModal(distanceInputId) {
            routeData.targetInput = distanceInputId;
            const modal = new bootstrap.Modal(document.getElementById('routeModal'));
            modal.show();
            
            document.getElementById('pointA').value = '';
            document.getElementById('pointB').value = '';
            document.getElementById('routeResults').style.display = 'none';
            document.getElementById('selectedDistance').value = '';
            routeData.routes = [];
            
            // Initialize map after modal is shown
            setTimeout(() => {
                initRouteMap();
            }, 300);
        }
        
        function initRouteMap() {
            if (routeMap) {
                routeMap.remove();
            }
            
            routeMap = L.map('routeMap').setView([49.0, 32.0], 6);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(routeMap);
            
            routeMap.on('click', function(e) {
                if (currentPointMode) {
                    setPointOnMap(currentPointMode, e.latlng.lat, e.latlng.lng);
                    currentPointMode = null;
                    document.body.style.cursor = 'default';
                }
            });
            
            // Add click handlers for map point selection
            document.getElementById('pointA').addEventListener('focus', () => {
                currentPointMode = 'A';
                document.body.style.cursor = 'crosshair';
            });
            
            document.getElementById('pointB').addEventListener('focus', () => {
                currentPointMode = 'B';
                document.body.style.cursor = 'crosshair';
            });
        }
        
        function setPointOnMap(point, lat, lng) {
            // Remove existing marker
            if (pointMarkers[point]) {
                routeMap.removeLayer(pointMarkers[point]);
            }
            
            // Add new marker
            const color = point === 'A' ? 'green' : 'red';
            pointMarkers[point] = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${point}</div>`,
                    iconSize: [20, 20]
                })
            }).addTo(routeMap);
            
            // Update input field
            document.getElementById(`point${point}`).value = `–¢–æ—á–∫–∞ ${point} (${lat.toFixed(6)}, ${lng.toFixed(6)})`;
        }
        
        function clearPoint(point) {
            document.getElementById(`point${point}`).value = '';
            if (pointMarkers[point]) {
                routeMap.removeLayer(pointMarkers[point]);
                pointMarkers[point] = null;
            }
        }
        
        async function getCurrentLocation(point) {
            try {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const lat = position.coords.latitude.toFixed(6);
                            const lng = position.coords.longitude.toFixed(6);
                            document.getElementById(`point${point}`).value = `–ú–æ—î –º—ñ—Å—Ü–µ (${lat}, ${lng})`;
                        },
                        async error => {
                            console.log('–ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ IP...');
                            await getLocationByIP(point);
                        }
                    );
                } else {
                    await getLocationByIP(point);
                }
            } catch (error) {
                alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è');
            }
        }
        
        async function getLocationByIP(point) {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                
                if (data.latitude && data.longitude) {
                    const city = data.city || '–ù–µ–≤—ñ–¥–æ–º–µ –º—ñ—Å—Ç–æ';
                    document.getElementById(`point${point}`).value = `${city} (${data.latitude}, ${data.longitude})`;
                } else {
                    throw new Error('IP location failed');
                }
            } catch (error) {
                alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è');
            }
        }
        
        async function searchCity(point) {
            const input = document.getElementById(`point${point}`);
            const query = input.value.trim();
            
            if (query.length < 2) {
                hideSuggestions(point);
                return;
            }
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ' –£–∫—Ä–∞—ó–Ω–∞')}&countrycodes=ua&limit=5`);
                const results = await response.json();
                
                showSuggestions(point, results);
            } catch (error) {
                console.error('Search error:', error);
            }
        }
        
        function showSuggestions(point, results) {
            const container = document.getElementById(`suggestions${point}`);
            
            if (results.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.innerHTML = results.map(result => {
                const name = result.display_name.split(',')[0];
                const village = result.address?.village || result.address?.town || result.address?.city || name;
                const municipality = result.address?.municipality || result.address?.county || '';
                const district = result.address?.state_district || result.address?.district || '';
                const region = result.address?.state || '';
                
                let locationDetails = [];
                if (municipality && municipality !== village) locationDetails.push(municipality);
                if (district && district !== municipality) locationDetails.push(district);
                if (region) locationDetails.push(region);
                
                const fullLocation = locationDetails.join(', ');
                
                return `
                    <div class="suggestion-item" onclick="selectSuggestion('${point}', '${village}', ${result.lat}, ${result.lon})">
                        <strong>${village}</strong><br>
                        <small class="text-muted">${fullLocation}</small>
                    </div>
                `;
            }).join('');
            
            container.style.display = 'block';
        }
        
        function selectSuggestion(point, name, lat, lng) {
            document.getElementById(`point${point}`).value = `${name} (${lat}, ${lng})`;
            hideSuggestions(point);
        }
        
        function hideSuggestions(point) {
            document.getElementById(`suggestions${point}`).style.display = 'none';
        }
        
        // Add input listeners for autocomplete
        document.addEventListener('DOMContentLoaded', function() {
            ['A', 'B'].forEach(point => {
                const input = document.getElementById(`point${point}`);
                if (input) {
                    input.addEventListener('input', () => searchCity(point));
                    input.addEventListener('blur', () => setTimeout(() => hideSuggestions(point), 200));
                }
            });
        });
        
        async function calculateAllRoutes() {
            const pointA = document.getElementById('pointA').value.trim();
            const pointB = document.getElementById('pointB').value.trim();
            
            if (!pointA || !pointB) {
                alert('–í–≤–µ–¥—ñ—Ç—å –æ–±–∏–¥–≤—ñ —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç—É');
                return;
            }
            
            try {
                const coordsA = await parseCoordinates(pointA);
                const coordsB = await parseCoordinates(pointB);
                
                if (!coordsA || !coordsB) {
                    alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏');
                    return;
                }
                
                await getMultipleRoutes(coordsA, coordsB);
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –º–∞—Ä—à—Ä—É—Ç—É');
            }
        }
        
        async function parseCoordinates(input) {
            const coordMatch = input.match(/\(([^)]+)\)/);
            if (coordMatch) {
                const coords = coordMatch[1].split(',');
                if (coords.length === 2) {
                    return { lat: parseFloat(coords[0].trim()), lng: parseFloat(coords[1].trim()) };
                }
            }
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(input)}&countrycodes=ua&limit=1`);
                const results = await response.json();
                if (results.length > 0) {
                    return { lat: parseFloat(results[0].lat), lng: parseFloat(results[0].lon) };
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
            return null;
        }
        
        async function getMultipleRoutes(coordsA, coordsB) {
            const coords = `${coordsA.lng},${coordsA.lat};${coordsB.lng},${coordsB.lat}`;
            routeData.routes = [];
            
            // Get multiple route alternatives from OSRM with geometry
            try {
                const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&alternatives=true&steps=false&continue_straight=false&geometries=geojson`);
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    data.routes.forEach((route, index) => {
                        let routeType = '–ù–∞–π–∫–æ—Ä–æ—Ç—à–∏–π –º–∞—Ä—à—Ä—É—Ç';
                        if (index === 1) routeType = '–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç';
                        if (index === 2) routeType = '–û–±—ñ–∑–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç';
                        if (index > 2) routeType = `–í–∞—Ä—ñ–∞–Ω—Ç ${index + 1}`;
                        
                        routeData.routes.push({
                            id: `osrm_${index}`,
                            type: routeType,
                            distance: (route.distance / 1000).toFixed(1),
                            duration: Math.round(route.duration / 60),
                            source: '–ù–∞–≤—ñ–≥–∞—Ç–æ—Ä OSRM',
                            geometry: route.geometry
                        });
                    });
                    
                    // Draw routes on map
                    drawRoutesOnMap(routeData.routes, coordsA, coordsB);
                }
            } catch (error) {
                console.error('OSRM error:', error);
            }
            
            // Add straight line distance
            const straightDistance = calculateStraightDistance(coordsA, coordsB);
            routeData.routes.push({
                id: 'straight',
                type: '–ü—Ä—è–º–∞ –ª—ñ–Ω—ñ—è (–º—ñ–Ω—ñ–º–∞–ª—å–Ω–∞)',
                distance: straightDistance.toFixed(1),
                duration: Math.round(straightDistance * 1.2),
                source: '–ì–µ–æ—Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫'
            });
            
            displayRouteOptions();
        }
        
        let routeLayers = [];
        
        function drawRoutesOnMap(routes, coordsA, coordsB) {
            // Clear existing route layers
            routeLayers.forEach(layer => routeMap.removeLayer(layer));
            routeLayers = [];
            
            const colors = ['#ff0000', '#0066ff', '#ff9900', '#9900ff'];
            
            routes.forEach((route, index) => {
                if (route.geometry) {
                    const routeLayer = L.geoJSON(route.geometry, {
                        style: {
                            color: colors[index] || '#666666',
                            weight: 4,
                            opacity: 0.7
                        }
                    }).addTo(routeMap);
                    
                    routeLayers.push(routeLayer);
                }
            });
            
            // Fit map to show all routes
            if (routeLayers.length > 0) {
                const group = new L.featureGroup(routeLayers);
                routeMap.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        function calculateStraightDistance(coordsA, coordsB) {
            const R = 6371;
            const dLat = (coordsB.lat - coordsA.lat) * Math.PI / 180;
            const dLng = (coordsB.lng - coordsA.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(coordsA.lat * Math.PI / 180) * Math.cos(coordsB.lat * Math.PI / 180) * Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function displayRouteOptions() {
            const container = document.getElementById('routeOptions');
            
            container.innerHTML = routeData.routes.map((route, index) => `
                <div class="route-option" onclick="selectRoute('${route.id}')" data-route="${route.id}">
                    <div class="route-info">
                        <div class="route-title">
                            ${route.type}
                            ${index === 0 ? '<span class="route-badge">–†–ï–ö–û–ú–ï–ù–î–û–í–ê–ù–û</span>' : ''}
                        </div>
                        <div class="route-details">
                            <i class="fas fa-map"></i> ${route.source} ‚Ä¢ 
                            <i class="fas fa-clock"></i> ~${route.duration} —Ö–≤
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="route-distance">${route.distance} –∫–º</div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('routeResults').style.display = 'block';
            
            if (routeData.routes.length > 0) {
                selectRoute(routeData.routes[0].id);
            }
        }
        
        function selectRoute(routeId) {
            document.querySelectorAll('.route-option').forEach(el => el.classList.remove('selected'));
            
            const selectedRoute = routeData.routes.find(r => r.id === routeId);
            if (selectedRoute) {
                const routeElement = document.querySelector(`[data-route="${routeId}"]`);
                if (routeElement) {
                    routeElement.classList.add('selected');
                }
                
                document.getElementById('selectedDistance').value = selectedRoute.distance;
                routeData.selectedRoute = selectedRoute;
            }
        }
        
        function useSelectedDistance() {
            if (routeData.selectedRoute && routeData.targetInput) {
                document.getElementById(routeData.targetInput).value = routeData.selectedRoute.distance;
                bootstrap.Modal.getInstance(document.getElementById('routeModal')).hide();
            } else {
                alert('–û–±–µ—Ä—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç');
            }
        }
        
        // Theme handling
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme || 'dark');
        }
        
        // Listen for theme changes
        window.addEventListener('message', function(event) {
            if (event.data.type === 'themeChange') {
                applyTheme(event.data.theme);
            }
        });
        
        window.addEventListener('message', function(event) {
            if (event.data.type === 'themeChange') {
                applyTheme(event.data.theme);
            }
        });
        
        // Apply initial theme and load saved values
        document.addEventListener('DOMContentLoaded', function() {
            const savedLang = localStorage.getItem('language') || 'uk';
            setLanguage(savedLang);
            updateLanguageButton(savedLang);
            
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);
            
            // Load saved values
            const savedDistance = localStorage.getItem('eore_distance');
            const savedFuelPrice = localStorage.getItem('eore_fuelPrice');
            const savedFuelConsumption = localStorage.getItem('eore_fuelConsumption');
            const savedTrips = localStorage.getItem('eore_trips');
            
            if (savedDistance) document.getElementById('eore-distance').value = savedDistance;
            if (savedFuelPrice) document.getElementById('fuel-price').value = savedFuelPrice;
            if (savedFuelConsumption) document.getElementById('fuel-consumption').value = savedFuelConsumption;
            if (savedTrips) document.getElementById('trips-count').value = savedTrips;
            
            // Add event listeners to save on change
            const inputs = ['eore-distance', 'fuel-price', 'fuel-consumption', 'trips-count'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', saveEOREValues);
                    element.addEventListener('change', saveEOREValues);
                }
            });
        });
        
        const translations = {
            uk: {
                'title': 'EORE Calculator',
                'subtitle': 'Explosive Ordnance Risk Education - –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤–∞—Ä—Ç–æ—Å—Ç—ñ –Ω–∞–≤—á–∞–Ω–Ω—è –∑ –±–µ–∑–ø–µ–∫–∏',
                'distance-label': '–í—ñ–¥—Å—Ç–∞–Ω—å –¥–æ –æ–±\'—î–∫—Ç–∞ (–∫–º)',
                'fuel-price-label': '–í–∞—Ä—Ç—ñ—Å—Ç—å –ø–∞–ª–∏–≤–∞ (–≥—Ä–Ω/–ª)',
                'fuel-consumption-label': '–†–æ–∑—Ö—ñ–¥ –ø–∞–ª–∏–≤–∞ (–ª/100–∫–º)',
                'trips-label': '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤–∏—ó–∑–¥—ñ–≤',
                'urgency-label': '–¢–µ—Ä–º—ñ–Ω–æ–≤—ñ—Å—Ç—å',
                'calc-btn': '–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏',
                'coeff-btn': '–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏',
                'route-btn': '–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –º–∞—Ä—à—Ä—É—Ç—É',
                'export-btn': '–ï–∫—Å–ø–æ—Ä—Ç PDF',
                'urgency-label-top': '–¢–µ—Ä–º—ñ–Ω–æ–≤—ñ—Å—Ç—å',
                'urgency-label': '–¢–µ—Ä–º—ñ–Ω–æ–≤—ñ—Å—Ç—å',
                'trips-note': '1 –≤–∏—ó–∑–¥ = —Ç—É–¥–∏ —Ç–∞ –Ω–∞–∑–∞–¥ (–ø–æ–¥–≤—ñ–π–Ω–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å)'
            },
            en: {
                'title': 'EORE Calculator',
                'subtitle': 'Explosive Ordnance Risk Education - Safety training cost calculation',
                'distance-label': 'Distance to object (km)',
                'fuel-price-label': 'Fuel price (UAH/l)',
                'fuel-consumption-label': 'Fuel consumption (l/100km)',
                'trips-label': 'Number of trips',
                'urgency-label': 'Urgency',
                'calc-btn': 'Calculate',
                'coeff-btn': 'Coefficients',
                'route-btn': 'Route Calculator',
                'export-btn': 'Export PDF',
                'urgency-label-top': 'Urgency',
                'urgency-label': 'Urgency',
                'trips-note': '1 trip = there and back (double distance)'
            },
            fr: {
                'title': 'Calculatrice EORE',
                'subtitle': '√âducation aux Risques des Munitions - Calcul du co√ªt de formation √† la s√©curit√©',
                'distance-label': 'Distance √† l\'objet (km)',
                'fuel-price-label': 'Prix du carburant (UAH/l)',
                'fuel-consumption-label': 'Consommation de carburant (l/100km)',
                'trips-label': 'Nombre de voyages',
                'urgency-label': 'Urgence',
                'calc-btn': 'Calculer',
                'coeff-btn': 'Coefficients',
                'route-btn': 'Calculateur d\'Itin√©raire',
                'export-btn': 'Exporter PDF',
                'urgency-label-top': 'Urgence',
                'urgency-label': 'Urgence',
                'trips-note': '1 voyage = aller-retour (double distance)'
            }
        };
        
        function setLanguage(lang) {
            const translation = translations[lang];
            if (translation) {
                for (const [key, value] of Object.entries(translation)) {
                    const element = document.getElementById(key);
                    if (element) {
                        element.textContent = value;
                    }
                }
            }
            localStorage.setItem('language', lang);
            updateLanguageButton(lang);
        }
        
        function toggleLanguage() {
            const currentLang = localStorage.getItem('language') || 'uk';
            const languages = ['uk', 'en', 'fr'];
            const currentIndex = languages.indexOf(currentLang);
            const nextIndex = (currentIndex + 1) % languages.length;
            setLanguage(languages[nextIndex]);
        }
        
        function updateLanguageButton(lang) {
            const flags = { uk: 'üá∫üá¶', en: 'üá∫üá∏', fr: 'üá´üá∑' };
            const btn = document.getElementById('langBtn');
            if (btn) btn.textContent = flags[lang] || flags.uk;
        }
        

        

        
        function saveEOREValues() {
            localStorage.setItem('eore_distance', document.getElementById('eore-distance').value);
            localStorage.setItem('eore_fuelPrice', document.getElementById('fuel-price').value);
            localStorage.setItem('eore_fuelConsumption', document.getElementById('fuel-consumption').value);
            localStorage.setItem('eore_trips', document.getElementById('trips-count').value);
        }
    </script>
</body>
</html>
